{% extends "base.html" %}
{% set active_page = "transactions" %}
{% block title %}Ledger — Transactions{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Transactions</h1>
    <div class="subtitle">{{ month }} &middot; {{ total }} records</div>
  </div>
</div>

<form class="filters" method="get" action="/transactions">
  <div class="filter-group">
    <label>Month</label>
    <input type="month" name="month" value="{{ month }}">
  </div>
  <div class="filter-group">
    <label>Category</label>
    <select name="category_id">
      <option value="">All</option>
      {% for group in category_tree %}
      <optgroup label="{{ group.parent.display_name }}">
        <option value="{{ group.parent.id }}" {% if filter_category == group.parent.id %}selected{% endif %}>All {{ group.parent.display_name }}</option>
        {% for c in group.children %}
        <option value="{{ c.id }}" {% if filter_category == c.id %}selected{% endif %}>{{ c.display_name }}</option>
        {% endfor %}
      </optgroup>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label>User</label>
    <select name="user_id">
      <option value="">All</option>
      {% for u in users %}
      <option value="{{ u.id }}" {% if filter_user == u.id %}selected{% endif %}>{{ u.display_name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label>Account</label>
    <select name="account_id">
      <option value="">All</option>
      {% for a in accounts %}
      <option value="{{ a.id }}" {% if filter_account == a.id %}selected{% endif %}>{{ a.display_name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label>Search</label>
    <input type="text" name="search" value="{{ filter_search }}" placeholder="description…">
  </div>
  <button class="btn btn-primary" type="submit">
    <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
    Filter
  </button>
</form>

<div class="panel">
  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Date</th>
        <th>Type</th>
        <th>Description</th>
        <th>Category</th>
        <th>User</th>
        <th style="text-align:right">Amount</th>
        <th>Account</th>
      </tr>
    </thead>
    <tbody>
      {% for t in txns %}
      <tr>
        <td style="color:var(--text3);font-size:0.75rem">{{ t.id }}</td>
        <td style="white-space:nowrap;color:var(--text2)">{{ t.effective_at.strftime('%d %b %H:%M') }}</td>
        <td><span class="badge badge-{{ t.transaction_type }}">{{ t.transaction_type }}</span></td>
        <td>
          <span style="font-weight:500">{{ t.description or '—' }}</span>
          {% if t.merchant %}<br><span style="color:var(--text3);font-size:0.75rem">{{ t.merchant }}</span>{% endif %}
        </td>
        <td style="color:var(--text2)">{{ cat_name_map.get(t.category_id, t.category_id) if t.category_id else '—' }}</td>
        <td style="font-weight:500">{{ t.user_id }}</td>
        <td class="amount type-{{ t.transaction_type }}" style="text-align:right">{{ idr(t.amount) }}</td>
        <td style="font-size:0.75rem;color:var(--text2)">
          {% if t.from_account_id and t.to_account_id %}
            {{ t.from_account_id }} → {{ t.to_account_id }}
          {% elif t.from_account_id %}
            {{ t.from_account_id }}
          {% elif t.to_account_id %}
            → {{ t.to_account_id }}
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if not txns %}
      <tr><td colspan="8" class="empty-state">No transactions found.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

{% if total_pages > 1 %}
<div class="pagination">
  {% if page > 1 %}
  <a href="?month={{ month }}&category_id={{ filter_category }}&user_id={{ filter_user }}&account_id={{ filter_account }}&search={{ filter_search }}&page={{ page - 1 }}">← Prev</a>
  {% endif %}
  <span>Page {{ page }} of {{ total_pages }}</span>
  {% if page < total_pages %}
  <a href="?month={{ month }}&category_id={{ filter_category }}&user_id={{ filter_user }}&account_id={{ filter_account }}&search={{ filter_search }}&page={{ page + 1 }}">Next →</a>
  {% endif %}
</div>
{% endif %}
{% endblock %}
