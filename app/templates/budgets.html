{% extends "base.html" %}
{% set active_page = "budgets" %}
{% block title %}Ledger — Budgets{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1>Budgets</h1>
    <div class="subtitle">{{ month }}</div>
  </div>
  <form class="filters" method="get" action="/budgets" style="margin-bottom:0">
    <div class="filter-group">
      <label>Month</label>
      <input type="month" name="month" value="{{ month }}">
    </div>
    <button class="btn btn-outline" type="submit">Go</button>
  </form>
</div>

{% if warnings %}
<div class="warnings">
  {% for w in warnings %}
  <div class="warning-item {{ w.severity.value }}">
    <svg style="width:16px;height:16px;flex-shrink:0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg>
    {{ w.message }}
  </div>
  {% endfor %}
</div>
{% endif %}

<div class="section-title">Set Budget Limits</div>
<form method="post" action="/budgets">
  <input type="hidden" name="month" value="{{ month }}">
  <div class="panel">
    <table>
      <thead>
        <tr>
          <th>Category</th>
          <th>Budget Limit (IDR)</th>
          <th>Used</th>
          <th>Remaining</th>
          <th style="min-width:150px">Progress</th>
        </tr>
      </thead>
      <tbody>
        {% for cat in parent_categories %}
        {% set current_limit = budget_limit_map.get(cat.id, 0) %}
        {% set status = None %}
        {% for b in budget_items %}
          {% if b.category_id == cat.id %}
            {% set status = b %}
          {% endif %}
        {% endfor %}
        <tr>
          <td style="font-weight:600">{{ cat.display_name }}</td>
          <td>
            <input type="number" name="limit_{{ cat.id }}"
                   value="{{ current_limit if current_limit else '' }}"
                   placeholder="0" min="0" step="50000"
                   style="width:150px;background:var(--white);border:1px solid var(--border);color:var(--text);padding:0.4rem 0.6rem;border-radius:var(--radius-sm);font-size:0.8125rem;font-family:inherit;outline:none"
                   onfocus="this.style.borderColor='var(--accent)';this.style.boxShadow='0 0 0 3px var(--accent-light)'"
                   onblur="this.style.borderColor='var(--border)';this.style.boxShadow='none'">
          </td>
          {% if status %}
          <td class="amount">{{ idr(status.used) }}</td>
          <td class="amount {% if status.remaining < 0 %}type-expense{% endif %}">{{ idr(status.remaining) }}</td>
          <td>
            {% set pct = (status.percent * 100)|round|int %}
            {% set cls = "pct-ok" if pct < 80 else ("pct-warn" if pct < 100 else "pct-over") %}
            <div style="display:flex;align-items:center;gap:8px">
              <div class="progress-wrap" style="flex:1">
                <div class="progress-bar {{ cls }}" style="width:{{ [pct, 100]|min }}%"></div>
              </div>
              <span style="font-size:0.75rem;font-weight:600;color:var(--text2);min-width:32px">{{ pct }}%</span>
            </div>
          </td>
          {% else %}
          <td class="amount" style="color:var(--text3)">—</td>
          <td class="amount" style="color:var(--text3)">—</td>
          <td style="color:var(--text3);font-size:0.75rem">No budget set</td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div style="margin-top:1rem">
    <button class="btn btn-primary" type="submit">
      <svg style="width:14px;height:14px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
      Save Budgets
    </button>
  </div>
</form>

{% if history %}
<div class="section" style="margin-top:2rem">
  <div class="section-title">Change History</div>
  <div class="panel">
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Category</th>
          <th style="text-align:right">Previous</th>
          <th style="text-align:right">New</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody>
        {% for h in history %}
        <tr>
          <td style="white-space:nowrap;color:var(--text2);font-size:0.75rem">{{ h.created_at.strftime('%d %b %Y %H:%M') }}</td>
          <td style="font-weight:500">{{ cat_name_map.get(h.changed_category_id, h.changed_category_id) }}</td>
          <td class="amount" style="text-align:right;color:var(--text3)">{{ idr(h.previous_amount) if h.previous_amount is not none else '—' }}</td>
          <td class="amount" style="text-align:right">{{ idr(h.new_amount) }}</td>
          <td style="font-size:0.75rem;color:var(--text2)">
            <span class="badge" style="background:var(--surface-hover);color:var(--text2)">{{ h.source }}</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}
{% endblock %}
