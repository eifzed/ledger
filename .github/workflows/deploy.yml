name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd ${{ secrets.APP_DIR }}
            git pull origin main
            docker compose down
            docker compose up -d --build

            # Sync OpenClaw prompt files and skills
            OPENCLAW_WS=${{ secrets.OPENCLAW_WORKSPACE }}
            cp openclaw/prompt/*.md "$OPENCLAW_WS/"
            mkdir -p "$OPENCLAW_WS/skills/finance-api/tools"
            cp openclaw/skills/finance-api/SKILL.md "$OPENCLAW_WS/skills/finance-api/"
            cp openclaw/skills/finance-api/api.sh "$OPENCLAW_WS/skills/finance-api/"
            chmod +x "$OPENCLAW_WS/skills/finance-api/api.sh"
            cp openclaw/skills/finance-api/tools/*.json "$OPENCLAW_WS/skills/finance-api/tools/"

            # Restart OpenClaw gateway and clear Discord sessions
            export PATH=/home/ubuntu/.npm-global/bin:$PATH
            openclaw gateway restart
            python3 -c "
            import json, glob
            for sf in glob.glob('/home/ubuntu/.openclaw/agents/*/sessions/sessions.json'):
                with open(sf) as f:
                    data = json.load(f)
                keys = [k for k in data if 'discord' in k.lower()]
                if keys:
                    for k in keys: del data[k]
                    with open(sf, 'w') as f:
                        json.dump(data, f, indent=2)
            "
